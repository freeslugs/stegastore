window.PNGDrive=function(b,a){this.VERSION_MAJOR=1;this.VERSION_MINOR=0;this.files=[];this.raw=new Uint8Array(0);if(typeof b!=="undefined"){this.decode(b,a)}};window.PNGDrive.prototype={addFile:function(a){this.files.push({name:a.name,type:a.type,fileRef:a})},addTextFile:function(c,a,b){this.files.push({name:a,type:b,content:this.utf8Encode(c)})},addBinaryFile:function(c,a,b){this.files.push({name:a,type:b,content:c})},removeAll:function(){this.files=[]},removeFileAt:function(a){if(a>=0&&a<this.files.length){this.files.splice(a,1)}},removeFileByName:function(a){for(var b=0;b<this.files.length;b++){if(this.files[b].name==a){this.files.splice(b,1);break}}},getFileCount:function(){return this.files.length},getFileAt:function(a){return(a>=0&&a<this.files.length)?this.files[a]:null},getFileByName:function(a){for(var b=0;b<this.files.length;b++){if(this.files[b].name==a){return this.files[b]}}return null},decode:function(h,q){if(typeof q=="undefined"){q=8}var d=document.createElement("canvas");var r=d.getContext("2d");d.width=h.width;d.height=h.height;r.drawImage(h,0,0);var m=r.getImageData(0,0,h.width,h.height);var b=m.data;var c=b.length;var e=this.raw=new Uint8Array(h.width*h.height*3);var l=0;if(q==8){var k=0;while(l<c){if(b[l+3]==255){e[k++]=b[l++];e[k++]=b[l++];e[k++]=b[l++];l++}else{l+=4}}}else{var n=new PNGDriveBitStream(e);while(l<c){if(b[l+3]==255){n.writeBits(q,b[l++]);n.writeBits(q,b[l++]);n.writeBits(q,b[l++]);l++}else{l+=4}}}if(e[0]==218&&e[1]==218){var p=e[4]|e[5]<<8|e[6]<<16|e[7]<<24;var a=e.subarray(8,8+p);var g=JSON.parse(this.utf8Decode(a));var o=8+p;this.files=[];for(l=0;l<g.files.length;l++){var f=g.files[l];var s=new Uint8Array(f.size);s.set(e.subarray(o,o+f.size));o+=f.size;this.files.push({name:f.name,type:f.type,content:s})}}return this},encode:function(b){var a=this;(function(g){var f=0;var h=a.getFileCount();for(var e=0;e<h;e++){var d=a.files[e];if(d.fileRef){f++;var c=new FileReader();c.onload=(function(i){return function(j){i.content=new Uint8Array(j.target.result);delete i.fileRef;if(--f==0&&e==h){f=-1;g.call(a)}}})(d);c.readAsArrayBuffer(d.fileRef)}}if(f==0){g.call(a)}})(function(){var e=this.getFileCount();if(e>0){var h,i,f;var g={files:[]};var m=0;for(h=0;h<e;h++){f=this.files[h];m+=f.content.byteLength;g.files.push({name:f.name,size:f.content.byteLength,type:f.type})}var c=this.utf8Encode(JSON.stringify(g));var l=c.byteLength;var k=8+l+m;var d=this.raw=new Uint8Array(k);d[0]=d[1]=218;d[2]=this.VERSION_MAJOR;d[3]=this.VERSION_MINOR;d[4]=l&255;d[5]=(l>>8)&255;d[6]=(l>>16)&255;d[7]=(l>>24)&255;d.set(c,8);for(h=0,i=8+c.byteLength;h<e;h++){f=this.files[h];d.set(f.content,i);i+=f.content.byteLength}}else{this.raw=new Uint8Array(0)}if(b){b.call(this)}})},createImage:function(k,l){var b=document.createElement("canvas");var m=b.getContext("2d");if(typeof k=="undefined"){l=8;var h=Math.ceil(Math.sqrt(this.raw.byteLength/3));b.width=h;b.height=h;m.fillRect(0,0,h,h)}else{if(typeof l=="undefined"){l=8}b.width=k.width;b.height=k.height;m.drawImage(k,0,0)}var e=m.getImageData(0,0,b.width,b.height);var a=e.data;var n=a.length;var d=0;if(l==8){var c=0;while(d<n){if(a[d+3]==255){a[d++]=this.raw[c++];a[d++]=this.raw[c++];a[d++]=this.raw[c++];d++}else{d+=4}}}else{var f=new PNGDriveBitStream(this.raw);var g=255^(255>>>(8-l));while(d<n){if(a[d+3]==255){a[d]=(a[d++]&g)|f.readBits(l);a[d]=(a[d++]&g)|f.readBits(l);a[d]=(a[d++]&g)|f.readBits(l);d++}else{d+=4}}}m.putImageData(e,0,0);return b},computeImageCapacity:function(g,h){if(typeof h=="undefined"){h=8}var b=document.createElement("canvas");var j=b.getContext("2d");b.width=g.width;b.height=g.height;j.drawImage(g,0,0);var d=j.getImageData(0,0,b.width,b.height);var a=d.data;var k=a.length;var c=0;var e=0;var f=h*3;while(c<k){if(a[c+3]==255){e+=f}c+=4}return e},utf8Encode:function(b){var d=[];var a=b.length;for(var f=0;f<a;f++){var e=b.charCodeAt(f);if(e<128){d.push(e)}else{if((e>127)&&(e<2048)){d.push((e>>6)|192);d.push((e&63)|128)}else{d.push((e>>12)|224);d.push(((e>>6)&63)|128);d.push((e&63)|128)}}}return new Uint8Array(d)},utf8Decode:function(b){var a=b.byteLength;var d="";var e=0;while(e<a){var f=b[e];if(f<128){d+=String.fromCharCode(f);e++}else{if((f>191)&&(f<224)&&(e+1<a)){d+=String.fromCharCode(((f&31)<<6)|(b[e+1]&63));e+=2}else{if(e+2<a){d+=String.fromCharCode(((f&15)<<12)|((b[e+1]&63)<<6)|(b[e+2]&63));e+=3}}}}return d}};window.PNGDriveBitStream=function(a){this.a=a;this.position=0;this.bitsPending=0};window.PNGDriveBitStream.prototype={writeBits:function(b,a){if(b==0){return}a&=(4294967295>>>(32-b));var c;if(this.bitsPending>0){if(this.bitsPending>b){this.a[this.position-1]|=a<<(this.bitsPending-b);c=b;this.bitsPending-=b}else{if(this.bitsPending==b){this.a[this.position-1]|=a;c=b;this.bitsPending=0}else{this.a[this.position-1]|=a>>(b-this.bitsPending);c=this.bitsPending;this.bitsPending=0}}}else{c=Math.min(8,b);this.bitsPending=8-c;this.a[this.position++]=(a>>(b-c))<<this.bitsPending}b-=c;if(b>0){this.writeBits(b,a)}},readBits:function(e,c){if(typeof c=="undefined"){c=0}if(e==0){return c}var d;var f;if(this.bitsPending>0){var a=this.a[this.position-1]&(255>>(8-this.bitsPending));f=Math.min(this.bitsPending,e);this.bitsPending-=f;d=a>>this.bitsPending}else{f=Math.min(8,e);this.bitsPending=8-f;d=this.a[this.position++]>>this.bitsPending}e-=f;c=(c<<f)|d;return(e>0)?this.readBits(e,c):c},seekTo:function(a){this.position=(a/8)|0;this.bitsPending=a%8;if(this.bitsPending>0){this.bitsPending=8-this.bitsPending;this.position++}}};
